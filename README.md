# ballancemaps-fetch

从 [Ballance 地图管理站（永硕网盘）](http://ballancemaps.ysepan.com/)拉取地图信息。以 JavaScript 实现，配有演示用 HTML 页面。

## 如何使用

### 结构

永硕网盘存储系统的结构如下:

* 目录1
    * 文件1.1
    * 文件1.2
* 目录2
    * 文件2.1
    * ...
* ...

永硕本身使用网盘用户名获取目录列表。目录本身存在数字编号；当用户点击目录时，使用目录的数字编号获取文件列表及属性等。

此外，Ballance 地图管理站对于文件的备注信息上**存在额外结构**：文件的备注信息总是以 `作者 | 难度 | 其他备注` 格式呈现，但难度和其他备注信息不一定存在。

### 获取目录列表

#### 方法

使用 `getGroupIndexes(样式: pattern)` 获取。关键词使用正则表达式，用于过滤出来满足样式的目录列表。

#### 返回

满足对应样式的目录的对象数组：
```
[
  {
    id: 目录的数字编号
    name: 目录名
​​​    notes: 备注信息
  },
  ...
]
```

加载失败或没有满足样式的目录时返回空数组。

#### 示例

`getGroupIndexes("Ballance自制地图")` 返回（此处仅截取其中一部分）：
```
[
  {
    id: "1767721",​​​
    name: "Ballance自制地图【HOT】",
    notes: "热评地图分区（截至2020年6月）"
  },
  {
    id: "1767719",
    name: "Ballance自制地图【CLASSIC】",
    notes: "经典地图分区（2015年及以前的经典地图）"
  },
  ...
]
```

### 获取地图文件列表

#### 方法

使用 `getMapList(目录编号: string)` 获取。目录编号对应前文的 `id`。

#### 返回

对应目录的地图文件内容的对象数组：
```
[
  {
    author: 作者,
    difficulty: 难度,
    name: 地图名称,
    notes: 其他备注信息,
    size: 文件大小,
    uploadTime: 文件上传时间,
    url: 下载链接
  },
  ...
]
```

难度数据 `difficulty` 使用数字格式表示，不存在时为 `-1`。

**注意：永硕的下载链接是会定期改变的，因此无法长期储存。**

#### 示例

`getMapList("1315478")` 返回（此处仅截取其中一部分）：
```
[
  {
    author: "BallanceBug",
    difficulty: -1,
    name: "210522图.nmo",
    notes: "",
    size: "1.8MB",
    uploadTime: "2021/5/30 12:48:42",
    url: "http://ys-O.ysepan.com/342124442/524199091/n475I5447FKQ8KT8RIkL2a/210522图.nmo"
  },
  {
    author: "Ballexer",
    difficulty: -1,
    name: "圈套.zip",
    notes: "2021-04-05更新版，规则同下",
    size: "12.3MB",
    uploadTime: "2021/5/22 23:47:52",
    url: "http://ys-N.ysepan.com/342124433/524187718/U6VHgNp863H6574GMP5T8e/圈套.zip"
  },
  ...
]
```

## 技术细节

### 加载永硕内容

永硕使用 AJAX 的方式加载目录和文件列表，加载时的 HTTP 请求需要含有 Referer 请求头，否则会提示错误。加载出的内容是永硕**已经生成好的格式化的 HTML** 及一些额外的脚本信息，所以需要将额外脚本过滤掉后解析 HTML。

### 解析 HTML

在 JS 内解析永硕的格式化 HTML 有以下二种方式：

- 使用 HTML 相关的解析器。
- 暴力正则表达式。

乍一看前者似乎必定是最佳方式，但其实不然：永硕本身没有真正意义上的稳定的 RESTful API，所获取到的 HTML 格式相当不便查找与解析。正则表达式反而是可行的，缺陷在于不可读性以及永硕目录结构时常的变动。

如果您期望将之移植到其他语言，尤其是那些不便解析 HTML 的语言中，请一定先了解好两种方式的优缺点。
